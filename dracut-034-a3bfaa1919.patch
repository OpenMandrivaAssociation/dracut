From a3bfaa191958c4b70d6c674f972c3b911f8b1bfa Mon Sep 17 00:00:00 2001
From: Vratislav Podzimek <vpodzime@redhat.com>
Date: Wed, 13 Nov 2013 12:20:39 +0000
Subject: Run 'xz' and 'lzma' with multiple threads

This speeds up compression a lot on multicore systems.

https://bugzilla.redhat.com/show_bug.cgi?id=1029786

[Edited-by: Harald Hoyer: use getconf for cpu_count]
---
diff -Naur dracut-034/dracut.sh dracut-034.tpg/dracut.sh
--- dracut-034/dracut.sh	Tue Oct 08 08:55:26 2013
+++ dracut-034.tpg/dracut.sh	Tue Nov 19 10:26:53 2013
@@ -681,12 +681,14 @@
 # eliminate IFS hackery when messing with fw_dir
 fw_dir=${fw_dir//:/ }
 
+cpu_count=$(getconf _NPROCESSORS_ONLN)
+
 # handle compression options.
 [[ $compress ]] || compress="gzip"
 case $compress in
     bzip2) compress="bzip2 -9";;
-    lzma)  compress="lzma -9";;
-    xz)    compress="xz --check=crc32 --lzma2=dict=1MiB";;
+    lzma)  compress="lzma -9 ${cpu_count:+-T$cpu_count}";;
+    xz)    compress="xz --check=crc32 --lzma2=dict=1MiB ${cpu_count:+-T$cpu_count}";;
     gzip)  compress="gzip -9"; command -v pigz > /dev/null 2>&1 && compress="pigz -9";;
 esac
 if [[ $_no_compress_l = "cat" ]]; then
--
cgit v0.9.2
